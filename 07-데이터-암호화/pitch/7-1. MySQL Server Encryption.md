## MySQL 서버의 데이터 암호화
- MySQL 5.7부터 지원된 암호화 기능은 처음에는 데이터 파일(테이블 스페이스)에 대해서만 암호화 기능이 제공
- MySQL 8.0 부터는 데이터 파일뿐만 아니라 리두 로그, 언두로그, 복제를 위한 바이너리 로그등 모두 암호화 기능을 지원
- MySQL 서버에서는 I/O레이어에서만 암호화/복호화를 수행함. 따라서 디스크 입출력 이외의 부분에서 암호화처리가 필요하지 않음
- 암호화 기능이 활성화 되고 있다고 해도 MySQL내부와 사용자 입장에서는 아무런 차이가 없기 때문에 이러한 방식을 가르켜 TDE(Transparent Data Encryption)이라고 한다.
- `Data at Rest Encryption` 이라고도 하는데 `Data at Reat`는 메모리(In-Process)나 네트워크 전송(In-Transit) 단계가 아닌 디스크에 저장(At Rest)된 단계에서만 암호화 된다는 의미로 사용되는 표현

### 1. 2단계 키관리
- 암호화키는 `KeyRing` 플러그인에 의해 관리됨.
- 마스터키와 테이블스페이스키(private key) 두가지의 키를 가지고 있음
- 암호화된 테이블이 생성될 때 마다 해당 테이블을 위한 임의의 테이블스페이스 키를 발급
- 마스터키를 이용해 테이블스페이스키를 암호화해서 각 테이블의 데이터 파일 헤더에 저장
- 따라서 테이블스페이스키는 외부로 노출되지 않기 때문에 주기적으로 변경하지 않아도 취약점이 되지 않지만, 마스터키는 외부의 파일을 이용하기 때문에 노출될 가능성이 있어 주기적인 변경이 권장됨
```sql
ALTER INSTANCE ROTATE INNODB MASTER KEY;
```
- 마스터키 변경시에 MySQL 서버는 기존 마스터키를 이용해 각 테이블스페이스 키를 복호화 한다음 새로운 마스터키로 다시 암호화한다
    - 키가 변경되는 동안 MySQL 서버의 테이블 스페이스 키 자체와 데이터 파일의 데이터는 전혀 변경되지 않는다.
    - 2단계 암호화 방식을 사용하는 이유는 암호화키(마스터키) 변경으로 인한 과도한 시스템 부하를 막기 위함
    - 테이블스페이스 키가 변경된다면 테이블의 데이터 파일을 다시 복호화 했다가 다시 암호화 해야함. 따라서 키를 변경할 때 마다 엄청난 작업이 필요하고 사용자 쿼리를 처리하는 데도 상당한 영향을 미침
- AES 256 알고리즘을 지원
    - 테이블 스페이스 키는 `AES-256 ECB` 알고리즘을 사용
    - 실제 데이터파일은 `AES-256 CBC` 알고리즘을 사용

> MySQL 8.0 버전에서 지원되는 키링 플러그인
> - keyring_file(File-Based 플러그인)
> - keyring_encrypted_file(Keyring 플러그인)(엔터프라이즈)
> - keyring_okv(KMIP 플러그인)(엔터프라이즈)
> - keyring_aws(Amazon Web Services Keyring 플러그인)(엔터프라이즈)

### 2. 암호화와 성능
- 디스크로부터 한번 읽은 데이터 페이지는 복호화되어 InnoDB 버퍼 풀에 적재된다. 그래서 데이터 페이지가 한번 메모리에 적재되면 암호화되지 않은 테이블과 동일한 성능을 보인다.
- 같은 테이블에 대해 암호화와 압축이 동시에 적용되면 MySQL 서버는 압축을 먼저 실행하고 암호화를 적용한다.
    - 일반적으로 암호화되 결과문은 아주 랜덤한 바이트의 배열을 가지게 되는데, 이는 압축률을 상당히 떨어뜨린다. 그래서 최대한 압축 효율을 높이기 위해 사용자의 데이터를 그대로 압추갷서 용량을 최소화한 후 암호화를 적용한다.
    - 또한 암호화된 테이블의 데이터 페이지는 복호화된 상태로 InnoDB 버퍼 풀에 저장되지만, 압축된 데이터 페이지는 압축 또는 압축 해제의 모든 상태로 InnoDB 버퍼 풀에 존재할 수 있따. 그래서 암호화기 먼저 실행되고 압축이 적용된다면 MySQL서버는 InnoDB 버퍼 풀에 존재하느 ㄴ데이터 페이지에 대해서도 매번 암복호화 작업을 수행해야 된다.

### 3. 암호화와 복제
- MySQL 서버에서 기본적으로 모든 노드는 각자의 마스터 키를 할당해야 한다.
- 마스터 키 자체가 레플리카로 복제되지 않기 때문에 테이블스페이스 키 또한 레플리카로 복제되지 않는다. 서로 각자의 마스터키, 테이블스페이스 키를 관리하기 때문에 실제 암호화된 데이터가 저장된 데이터 파일의 내용은 완전히 달라진다.
- `ALTER INSTANCE ROTATE INNODB MASTER KEY` 명령자체는 레플리카로 복제되지만 실제 소스 서버의 마스터키가 레플리카 서버로 전달되지 않음. 따라서 마스터키 로테이션을 실행하면 소스 서버와 레플리카 서버 각각 서로 다른 마스터키를 새로 발급받는다.
- 서버 백업시 KeyRing 파일을 백업하지 않을 때 키링 파일을 찾지 못하면 데이터를 복구할 수 없다. 또한 키링 파일 백업을 데이터 백업과 별도로 진행하면 마스터 키 로테이션 명령으로 마스터키가 언제 변경됬는지까지 기억하고 있어야 함.
- 데이터 파일과 키링 파일을 별도로 보관하는 것을 권장하지만 복구를 감안한 백업 방식 선택이 필요함